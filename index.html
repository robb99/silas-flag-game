<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flags of the World ‚Äî Silas Quiz</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#1b2a6b;
      --card:#0f1736cc;
      --card2:#0c122dcc;
      --text:#f6f7ff;
      --muted:#c9d1ff;
      --good:#2ee59d;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --btn:#2b3fff;
      --btn2:#ff3d9a;
      --shadow: 0 18px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text);
      min-height:100vh;
      background:
        radial-gradient(1200px 500px at 20% 5%, rgba(255,61,154,.25), transparent 55%),
        radial-gradient(900px 420px at 85% 20%, rgba(46,229,157,.20), transparent 55%),
        radial-gradient(800px 500px at 30% 90%, rgba(43,63,255,.25), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    header{
      padding:18px 14px 10px;
      position:sticky;
      top:0;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.15));
      z-index:10;
    }

    .wrap{ max-width: 980px; margin:0 auto; padding: 0 14px 26px; overflow-x: hidden; }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    h1{
      font-size: clamp(18px, 2.6vw, 26px);
      margin:0;
      letter-spacing: .2px;
    }
    .sub{
      margin:4px 0 0;
      font-size: 13px;
      color:var(--muted);
    }

    .pillRow{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:space-between;
    }

    .pills{ display:flex; gap:8px; flex-wrap:wrap; }

    .pill{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      padding:8px 10px;
      border-radius: 999px;
      font-size: 13px;
      display:flex;
      gap:8px;
      align-items:center;
      box-shadow: 0 10px 20px rgba(0,0,0,.12);
    }

    .pill b{ color:#fff; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }

    button{
      cursor:pointer;
      border:none;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 800;
      letter-spacing: .2px;
      color:white;
      background: linear-gradient(135deg, rgba(43,63,255,1), rgba(255,61,154,1));
      box-shadow: var(--shadow);
      transition: transform .12s ease, filter .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: scale(.98); }
    button.secondary{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.20);
      box-shadow: 0 14px 28px rgba(0,0,0,.24);
    }
    button.ghost{
      background: transparent;
      border: 1px dashed rgba(255,255,255,.30);
      box-shadow:none;
    }
    button.start{
      font-size: 24px;
      padding: 20px 40px;
      animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(46,229,157,.7); }
      50% { transform: scale(1.03); box-shadow: 0 0 20px 10px rgba(46,229,157,.3); }
    }

    main{ padding-top: 8px; }

    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
    }

    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
      position:relative;
    }

    .modeTabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      color: white;
    }
    .tab[aria-selected="true"]{
      background: linear-gradient(135deg, rgba(46,229,157,.95), rgba(43,63,255,.95));
      border-color: rgba(255,255,255,.28);
    }

    .difficulty{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    select{
      appearance:none;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.18);
      color: white;
      font-weight: 800;
      box-shadow: 0 12px 22px rgba(0,0,0,.18);
    }

    .quiz{
      display:grid;
      gap:14px;
      align-items:center;
      grid-template-columns: 1fr;
    }

    .flagBox{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      min-height: 180px;
      position:relative;
    }

    .flagImg{
      width: 100%;
      max-width: 420px;
      height:auto;
      border-radius: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.22);
    }

    .flagHint{
      position:absolute;
      top:10px;
      left:10px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--muted);
    }

    .strikes{
      position:absolute;
      top:10px;
      right:10px;
      font-size: 18px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--bad);
      letter-spacing: 2px;
    }

    .question{
      font-size: clamp(18px, 2.8vw, 26px);
      font-weight: 1000;
      margin: 0;
    }

    .answers{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .answerBtn{
      text-align:left;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 22px rgba(0,0,0,.20);
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
      word-break: break-word;
    }
    .answerBtn:hover{ filter: brightness(1.06); }

    .answerBtn[disabled]{ cursor:not-allowed; opacity:.85; }

    .badge{
      font-size:12px;
      font-weight: 1000;
      padding: 6px 9px;
      border-radius: 999px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.16);
      color: var(--muted);
      white-space:nowrap;
    }

    .answerBtn.correct{
      background: linear-gradient(135deg, rgba(46,229,157,.90), rgba(43,63,255,.55));
      border-color: rgba(255,255,255,.30);
    }
    .answerBtn.wrong{
      background: linear-gradient(135deg, rgba(255,92,122,.92), rgba(255,209,102,.35));
      border-color: rgba(255,255,255,.25);
    }

    .feedback{
      margin-top: 6px;
      padding: 12px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.14);
      display:none;
    }
    .feedback.show{ display:block; }

    .feedbackTitle{ font-weight: 1000; margin:0 0 6px; }
    .feedbackBody{ margin:0; color: var(--muted); line-height:1.35; }

    .nextRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top: 10px; }

    .progressBarWrap{
      height: 12px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      overflow:hidden;
      flex:1;
      min-width: 160px;
    }
    .progressBar{
      height:100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(46,229,157,1), rgba(43,63,255,1), rgba(255,61,154,1));
      border-radius: 999px;
      transition: width .35s ease;
    }

    .learnGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .learnItem{
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px;
      box-shadow: 0 12px 22px rgba(0,0,0,.18);
      display:grid;
      gap:8px;
      align-content:start;
    }
    .learnItem img{
      width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.10);
    }
    .learnItem .name{ font-weight: 1000; }
    .learnItem .fact{ color: var(--muted); font-size: 13px; line-height:1.25; }

    .footerNote{
      color: rgba(255,255,255,.75);
      font-size: 12px;
      margin-top: 12px;
      text-align:center;
    }

    /* Start screen */
    .startScreen{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      min-height: 300px;
      text-align: center;
    }
    .startScreen .flagImg{
      max-width: 280px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .startScreen h2{
      margin: 0;
      font-size: clamp(24px, 4vw, 36px);
    }
    .startScreen p{
      margin: 0;
      color: var(--muted);
      max-width: 300px;
    }

    /* Game Over screen */
    .gameOverScreen{
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 24px;
      min-height: 350px;
      text-align: center;
      padding: 30px;
    }
    .gameOverScreen.show{
      display: flex;
    }
    .gameOverScreen h2{
      margin: 0;
      font-size: clamp(28px, 5vw, 42px);
      color: var(--bad);
    }
    .gameOverScreen .finalScore{
      font-size: clamp(60px, 12vw, 100px);
      font-weight: 1000;
      background: linear-gradient(135deg, var(--good), var(--btn), var(--btn2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .gameOverScreen .scoreLabel{
      font-size: 18px;
      color: var(--muted);
      margin-top: -10px;
    }
    .gameOverScreen .stats{
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .gameOverScreen .stat{
      text-align: center;
    }
    .gameOverScreen .statValue{
      font-size: 28px;
      font-weight: 1000;
    }
    .gameOverScreen .statLabel{
      font-size: 12px;
      color: var(--muted);
    }
    .gameOverScreen button{
      font-size: 20px;
      padding: 16px 32px;
    }

    /* Milestone celebration flash */
    @keyframes celebrate {
      0% { transform: scale(1); }
      15% { transform: scale(1.15); }
      30% { transform: scale(1); }
      45% { transform: scale(1.1); }
      60% { transform: scale(1); }
      100% { transform: scale(1); }
    }
    .celebrate {
      animation: celebrate 0.6s ease-out;
    }

    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .flash {
      animation: flash 0.15s ease-out 3;
    }

    /* Confetti canvas */
    #fxCanvas{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:999;
    }

    /* Little wiggle animation */
    @keyframes pop {
      0%{ transform: scale(.9); opacity:.4; }
      60%{ transform: scale(1.02); opacity:1; }
      100%{ transform: scale(1); }
    }
    .pop{ animation: pop .22s ease-out; }

    /* Level up animation */
    @keyframes levelUp {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.2) rotate(-5deg); }
      50% { transform: scale(1.3) rotate(5deg); }
      75% { transform: scale(1.2) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }
    .levelUp {
      animation: levelUp 0.8s ease-out;
    }

    @media (min-width: 820px){
      .grid{ grid-template-columns: 1.2fr .8fr; align-items:start; }
      .quiz{ grid-template-columns: 1.05fr .95fr; }
      .answers{ grid-template-columns: 1fr; }
      .learnGrid{ grid-template-columns: repeat(3, 1fr); }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; animation:none !important; scroll-behavior:auto !important; }
    }
  </style>
</head>
<body>
  <canvas id="fxCanvas"></canvas>

  <header>
    <div class="wrap">
      <div class="topRow">
        <div>
          <h1>Flags of the World ‚Äî Silas Quiz</h1>
          <p class="sub">Pick the right country. Build a streak. Become a flag ninja.</p>
        </div>
        <div class="btnRow">
          <button id="btnReset" class="secondary" title="Reset your progress">Reset</button>
        </div>
      </div>

      <div class="pillRow">
        <div class="pills">
          <div class="pill">Score: <b id="score">0</b></div>
          <div class="pill">Streak: <b id="streak">0</b></div>
          <div class="pill">Best streak: <b id="bestStreak">0</b></div>
          <div class="pill">Learned: <b id="learned">0</b>/<span id="poolSize">0</span></div>
        </div>
        <div class="btnRow">
          <button id="btnSound" class="secondary" title="Toggle sound">Sound: ON</button>
          <button id="btnNext" title="Next flag">Next ‚ûú</button>
        </div>
      </div>

      <div class="modeTabs">
        <div class="tabs" role="tablist" aria-label="Mode">
          <button class="tab" role="tab" id="tabQuiz" aria-selected="true">Quiz Mode</button>
          <button class="tab" role="tab" id="tabLearn" aria-selected="false">Learn Mode</button>
        </div>
        <div class="difficulty">
          <span class="pill" style="margin:0">Difficulty</span>
          <select id="difficultySelect" aria-label="Difficulty">
            <option value="easy">Easy ‚≠ê</option>
            <option value="medium">Medium ‚≠ê‚≠ê</option>
            <option value="hard">Hard ‚≠ê‚≠ê‚≠ê</option>
          </select>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card" id="quizCard">
        <!-- Start Screen -->
        <div class="startScreen" id="startScreen">
          <img class="flagImg" src="https://flagcdn.com/w640/un.png" alt="United Nations Flag" />
          <h2>üåç Ready to explore?</h2>
          <p>Test your knowledge of flags from around the world!</p>
          <button class="start" id="btnStart">Start Game! üöÄ</button>
        </div>

        <!-- Game Over Screen -->
        <div class="gameOverScreen" id="gameOverScreen">
          <h2>üí• Game Over!</h2>
          <div class="finalScore" id="finalScore">0</div>
          <div class="scoreLabel">POINTS</div>
          <div class="stats">
            <div class="stat">
              <div class="statValue" id="finalStreak">0</div>
              <div class="statLabel">Best Streak</div>
            </div>
            <div class="stat">
              <div class="statValue" id="finalLearned">0</div>
              <div class="statLabel">Flags Learned</div>
            </div>
            <div class="stat">
              <div class="statValue" id="finalLevel">Easy</div>
              <div class="statLabel">Highest Level</div>
            </div>
          </div>
          <button id="btnTryAgain">Try Again! üîÑ</button>
        </div>

        <!-- Quiz Content -->
        <div class="quiz" id="quizContent" style="display:none">
          <div class="flagBox">
            <div class="flagHint" id="flagHint">Loading‚Ä¶</div>
            <div class="strikes" id="strikes">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
            <img id="flagImg" class="flagImg" alt="Flag" src="https://flagcdn.com/w640/un.png" />
          </div>
          <div>
            <p class="question" id="question">Which country is this flag?</p>
            <div class="answers" id="answers"></div>

            <div id="feedback" class="feedback" aria-live="polite">
              <p class="feedbackTitle" id="feedbackTitle"></p>
              <p class="feedbackBody" id="feedbackBody"></p>
            </div>

            <div class="nextRow">
              <div class="progressBarWrap" aria-label="Progress">
                <div class="progressBar" id="progressBar"></div>
              </div>
            </div>

            <div class="footerNote">Tip: If you get it wrong, no worries ‚Äî the goal is to learn!</div>
          </div>
        </div>
      </section>

      <aside class="card" id="sideCard">
        <h2 style="margin:0 0 10px; font-size:18px">Your Mission</h2>
        <div style="display:grid; gap:10px">
          <div class="pill" id="challengePill" style="justify-content:space-between">
            <span>Daily challenge</span>
            <span class="badge" id="challenge">Get a 5 streak</span>
          </div>
          <div class="pill" id="bonusPill" style="justify-content:space-between">
            <span>Streak bonus</span>
            <span class="badge" id="bonus">x1</span>
          </div>
          <div class="pill" style="justify-content:space-between">
            <span>Mode</span>
            <span class="badge" id="modeBadge">Quiz</span>
          </div>

          <div class="card" style="padding:12px; background: rgba(255,255,255,.06)">
            <div style="font-weight:1000; margin-bottom:6px">How scoring works</div>
            <div style="color:var(--muted); font-size:13px; line-height:1.35">
              Correct = <b>+10</b>. If you have a streak, you get a bonus.
              3 wrong = Game Over! But you can always try again!
            </div>
          </div>

          <button id="btnShuffle" class="ghost">Shuffle Flags üîÄ</button>
        </div>
      </aside>

      <section class="card" id="learnCard" style="display:none">
        <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap">
          <h2 style="margin:0; font-size:18px">Learn Mode</h2>
          <div class="pill">Study the flags, then go Quiz!</div>
        </div>
        <div style="margin-top:12px" class="learnGrid" id="learnGrid"></div>
        <div class="footerNote">Flags are loaded from <span style="opacity:.9">flagcdn.com</span>. Works offline-ish after they are cached.</div>
      </section>
    </div>
  </main>

  <script>
    /*********************
     * Data
     *********************/
    // Using ISO 3166-1 alpha-2 codes for flagcdn.
    // Facts are kid-friendly and short.
    const COUNTRY_BANK = {
      easy: [
        { code:'us', name:'United States', fact:'50 stars = 50 states!' },
        { code:'ca', name:'Canada', fact:'The leaf is a maple leaf.' },
        { code:'mx', name:'Mexico', fact:'The eagle and snake are from an old legend.' },
        { code:'br', name:'Brazil', fact:'The green and yellow are super famous in sports.' },
        { code:'ar', name:'Argentina', fact:'The sun is called the Sun of May.' },
        { code:'gb', name:'United Kingdom', fact:'It combines crosses from different nations.' },
        { code:'fr', name:'France', fact:'Blue‚Äìwhite‚Äìred is called the Tricolour.' },
        { code:'de', name:'Germany', fact:'Black‚Äìred‚Äìgold is a classic trio.' },
        { code:'it', name:'Italy', fact:'Green‚Äìwhite‚Äìred like a tasty pizza vibe.' },
        { code:'es', name:'Spain', fact:'The coat of arms tells a long story.' },
        { code:'pt', name:'Portugal', fact:'The shield comes from old kingdoms.' },
        { code:'nl', name:'Netherlands', fact:'Red‚Äìwhite‚Äìblue inspired other flags too.' },
        { code:'be', name:'Belgium', fact:'The stripes are vertical.' },
        { code:'ch', name:'Switzerland', fact:'One of the only square flags!' },
        { code:'se', name:'Sweden', fact:'The Nordic cross style is used in nearby countries.' },
        { code:'no', name:'Norway', fact:'Nordic cross = a cross that reaches the edges.' },
        { code:'dk', name:'Denmark', fact:'It's one of the oldest flags still used.' },
        { code:'fi', name:'Finland', fact:'Blue cross on white like snow and lakes.' },
        { code:'jp', name:'Japan', fact:'The red circle represents the sun.' },
        { code:'cn', name:'China', fact:'Five stars show unity.' },
        { code:'in', name:'India', fact:'The blue wheel is the Ashoka Chakra.' },
        { code:'au', name:'Australia', fact:'Southern Cross stars are in the sky there.' },
        { code:'nz', name:'New Zealand', fact:'It has 4 red stars with white borders.' },
        { code:'za', name:'South Africa', fact:'One flag shows many paths coming together.' },
        { code:'ru', name:'Russia', fact:'White, blue, and red horizontal stripes.' },
        { code:'kr', name:'South Korea', fact:'The symbols are about balance (yin-yang).' },
        { code:'ie', name:'Ireland', fact:'Green‚Äìwhite‚Äìorange vertical stripes.' },
        { code:'gr', name:'Greece', fact:'Blue and white like sea and sky.' },
        { code:'pl', name:'Poland', fact:'White on top, red on bottom.' },
        { code:'at', name:'Austria', fact:'Red‚Äìwhite‚Äìred is super old.' },
        { code:'hu', name:'Hungary', fact:'Red, white, and green horizontal stripes.' },
        { code:'tr', name:'T√ºrkiye', fact:'The crescent and star are classic symbols.' },
        { code:'eg', name:'Egypt', fact:'The eagle is a powerful symbol.' },
        { code:'th', name:'Thailand', fact:'The middle blue stripe is the biggest.' },
        { code:'id', name:'Indonesia', fact:'Red on top, white on bottom.' },
        { code:'my', name:'Malaysia', fact:'Has stripes AND a moon and star!' },
        { code:'sg', name:'Singapore', fact:'Crescent + 5 stars.' },
        { code:'vn', name:'Vietnam', fact:'A single star in the center.' },
        { code:'ph', name:'Philippines', fact:'The sun has 8 rays!' },
        { code:'cl', name:'Chile', fact:'One star = "La Estrella Solitaria".' },
        { code:'co', name:'Colombia', fact:'The yellow stripe is extra wide.' },
        { code:'pe', name:'Peru', fact:'Red‚Äìwhite‚Äìred, often with a crest.' },
        { code:'ve', name:'Venezuela', fact:'Blue with stars and yellow, blue, red stripes.' },
        { code:'ec', name:'Ecuador', fact:'Similar to Colombia but with a crest!' },
        { code:'ke', name:'Kenya', fact:'The shield and spears show protection.' },
        { code:'ng', name:'Nigeria', fact:'Green‚Äìwhite‚Äìgreen is easy to spot.' },
        { code:'gh', name:'Ghana', fact:'The black star is famous!' },
        { code:'ma', name:'Morocco', fact:'The green star is called the Seal of Solomon.' },
      ],
      medium: [
        { code:'sa', name:'Saudi Arabia', fact:'It includes Arabic writing.' },
        { code:'il', name:'Israel', fact:'The star is called the Star of David.' },
        { code:'ir', name:'Iran', fact:'A special pattern repeats along the borders.' },
        { code:'pk', name:'Pakistan', fact:'The moon and star stand out at night.' },
        { code:'et', name:'Ethiopia', fact:'One of the oldest independent countries in Africa.' },
        { code:'ua', name:'Ukraine', fact:'Blue sky over golden fields.' },
        { code:'cz', name:'Czechia', fact:'A triangle plus stripes.' },
        { code:'cu', name:'Cuba', fact:'Triangle + star + stripes.' },
        { code:'do', name:'Dominican Republic', fact:'A cross splits the flag into four parts.' },
        { code:'jm', name:'Jamaica', fact:'It has a big X (saltire)!' },
        { code:'is', name:'Iceland', fact:'Nordic cross with red and white.' },
        { code:'ro', name:'Romania', fact:'Blue‚Äìyellow‚Äìred vertical stripes.' },
        { code:'bg', name:'Bulgaria', fact:'White‚Äìgreen‚Äìred horizontal stripes.' },
        { code:'rs', name:'Serbia', fact:'Red, blue, white with a coat of arms.' },
        { code:'hr', name:'Croatia', fact:'Has a checkered shield!' },
        { code:'sk', name:'Slovakia', fact:'A double cross in the crest.' },
        { code:'si', name:'Slovenia', fact:'It has a mountain and stars in the shield.' },
        { code:'ee', name:'Estonia', fact:'Blue‚Äìblack‚Äìwhite stripes.' },
        { code:'lv', name:'Latvia', fact:'A dark red with a thin white stripe.' },
        { code:'lt', name:'Lithuania', fact:'Yellow‚Äìgreen‚Äìred stripes.' },
        { code:'cy', name:'Cyprus', fact:'The map of the island is on the flag!' },
        { code:'mt', name:'Malta', fact:'A small cross in the corner.' },
        { code:'lu', name:'Luxembourg', fact:'Like Netherlands but lighter blue.' },
        { code:'uy', name:'Uruguay', fact:'A sun with a face ‚Äî hello!' },
        { code:'py', name:'Paraguay', fact:'Different emblem on each side!' },
        { code:'bo', name:'Bolivia', fact:'Red, yellow, green horizontal stripes.' },
        { code:'pa', name:'Panama', fact:'Four quarters with stars.' },
        { code:'cr', name:'Costa Rica', fact:'Blue, white, red horizontal bands.' },
        { code:'gt', name:'Guatemala', fact:'Blue and white with a quetzal bird.' },
        { code:'hn', name:'Honduras', fact:'Blue stripes with 5 stars.' },
        { code:'sv', name:'El Salvador', fact:'Blue and white with a crest.' },
        { code:'ni', name:'Nicaragua', fact:'Blue, white, blue with a triangle.' },
        { code:'tz', name:'Tanzania', fact:'Diagonal stripe design.' },
        { code:'ug', name:'Uganda', fact:'Has a crane bird in the center!' },
        { code:'zm', name:'Zambia', fact:'Eagle flying over green, red, orange, black.' },
        { code:'zw', name:'Zimbabwe', fact:'Seven stripes with a bird.' },
        { code:'sn', name:'Senegal', fact:'Green star in the middle.' },
        { code:'ci', name:'C√¥te d\'Ivoire', fact:'Orange, white, green (like Ireland reversed!)' },
        { code:'cm', name:'Cameroon', fact:'Green, red, yellow with a star.' },
        { code:'ao', name:'Angola', fact:'Has a machete and gear.' },
        { code:'dz', name:'Algeria', fact:'Green and white with crescent and star.' },
        { code:'tn', name:'Tunisia', fact:'A red flag with a white circle and crescent.' },
        { code:'lb', name:'Lebanon', fact:'Has a cedar tree!' },
        { code:'jo', name:'Jordan', fact:'Black, white, green stripes with red triangle.' },
        { code:'ae', name:'United Arab Emirates', fact:'Red, green, white, black stripes.' },
        { code:'kw', name:'Kuwait', fact:'Green, white, red with black trapezoid.' },
        { code:'qa', name:'Qatar', fact:'Maroon and white with a zigzag edge.' },
        { code:'om', name:'Oman', fact:'Red, white, green with national emblem.' },
        { code:'bd', name:'Bangladesh', fact:'Green with a red circle.' },
        { code:'lk', name:'Sri Lanka', fact:'It has a lion holding a sword.' },
        { code:'mm', name:'Myanmar', fact:'Red, green, yellow with a white star.' },
        { code:'kh', name:'Cambodia', fact:'Has Angkor Wat temple on it!' },
        { code:'la', name:'Laos', fact:'Blue, red with white circle.' },
        { code:'np', name:'Nepal', fact:'The only non-rectangular national flag!' },
      ],
      hard: [
        { code:'bt', name:'Bhutan', fact:'The dragon is called Druk (Thunder Dragon)!' },
        { code:'mn', name:'Mongolia', fact:'The symbol is called the Soyombo.' },
        { code:'kz', name:'Kazakhstan', fact:'The eagle is soaring under the sun.' },
        { code:'uz', name:'Uzbekistan', fact:'The stars and moon are near the top.' },
        { code:'tm', name:'Turkmenistan', fact:'Has 5 carpet patterns!' },
        { code:'kg', name:'Kyrgyzstan', fact:'A sun with 40 rays (40 tribes)!' },
        { code:'tj', name:'Tajikistan', fact:'Has a crown and 7 stars.' },
        { code:'af', name:'Afghanistan', fact:'Has a mosque in the center.' },
        { code:'ge', name:'Georgia', fact:'Five crosses total.' },
        { code:'am', name:'Armenia', fact:'Three horizontal stripes: red, blue, orange.' },
        { code:'az', name:'Azerbaijan', fact:'Crescent + star on a blue-red-green flag.' },
        { code:'md', name:'Moldova', fact:'Similar colors to Romania, but with a crest.' },
        { code:'al', name:'Albania', fact:'A black double-headed eagle!' },
        { code:'ba', name:'Bosnia and Herzegovina', fact:'Blue with yellow triangle and stars.' },
        { code:'mk', name:'North Macedonia', fact:'A bright sun with rays.' },
        { code:'me', name:'Montenegro', fact:'Red with gold border and eagle.' },
        { code:'xk', name:'Kosovo', fact:'Blue with gold map and stars.' },
        { code:'by', name:'Belarus', fact:'Red, green with decorative pattern.' },
        { code:'rw', name:'Rwanda', fact:'A sun in the top right corner.' },
        { code:'mz', name:'Mozambique', fact:'One flag includes a book and a hoe.' },
        { code:'na', name:'Namibia', fact:'Diagonal stripe with a sun.' },
        { code:'bw', name:'Botswana', fact:'Light blue with black and white stripe.' },
        { code:'sz', name:'Eswatini', fact:'Has a shield and spears!' },
        { code:'ls', name:'Lesotho', fact:'Has a traditional hat on it!' },
        { code:'mw', name:'Malawi', fact:'Black, red, green with rising sun.' },
        { code:'mg', name:'Madagascar', fact:'White, red, green vertical stripes.' },
        { code:'mu', name:'Mauritius', fact:'Four horizontal colored stripes.' },
        { code:'sc', name:'Seychelles', fact:'Rays of different colors!' },
        { code:'gm', name:'Gambia', fact:'Red, blue, green horizontal with white borders.' },
        { code:'gw', name:'Guinea-Bissau', fact:'Red, yellow, green with black star.' },
        { code:'gn', name:'Guinea', fact:'Red, yellow, green vertical stripes.' },
        { code:'ml', name:'Mali', fact:'Green, yellow, red vertical stripes.' },
        { code:'bf', name:'Burkina Faso', fact:'Red, green with yellow star.' },
        { code:'ne', name:'Niger', fact:'Orange, white, green with orange circle.' },
        { code:'td', name:'Chad', fact:'Blue, yellow, red (almost like Romania!)' },
        { code:'cf', name:'Central African Republic', fact:'Four stripes with a star.' },
        { code:'cg', name:'Republic of the Congo', fact:'Green, yellow, red diagonal.' },
        { code:'cd', name:'DR Congo', fact:'Blue with yellow star and red stripe.' },
        { code:'ga', name:'Gabon', fact:'Green, yellow, blue horizontal.' },
        { code:'gq', name:'Equatorial Guinea', fact:'Green, white, red with blue triangle.' },
        { code:'st', name:'S√£o Tom√© and Pr√≠ncipe', fact:'Green, yellow, green with stars.' },
        { code:'cv', name:'Cape Verde', fact:'Blue with stars in a circle.' },
        { code:'mr', name:'Mauritania', fact:'Green with gold crescent and star.' },
        { code:'er', name:'Eritrea', fact:'Red triangle with olive branch.' },
        { code:'dj', name:'Djibouti', fact:'Light blue, green with white triangle.' },
        { code:'so', name:'Somalia', fact:'Light blue with white star.' },
        { code:'fj', name:'Fiji', fact:'Light blue with a shield.' },
        { code:'pg', name:'Papua New Guinea', fact:'A bird-of-paradise is on it.' },
        { code:'sb', name:'Solomon Islands', fact:'Diagonal split with stars.' },
        { code:'vu', name:'Vanuatu', fact:'A boar's tusk symbol appears.' },
        { code:'ws', name:'Samoa', fact:'Red with blue rectangle and stars.' },
        { code:'to', name:'Tonga', fact:'Red with white corner and cross.' },
        { code:'ki', name:'Kiribati', fact:'Sun rising over waves with bird!' },
        { code:'tv', name:'Tuvalu', fact:'Light blue with union jack and stars.' },
        { code:'nr', name:'Nauru', fact:'Blue with yellow stripe and white star.' },
        { code:'pw', name:'Palau', fact:'Light blue with yellow circle.' },
        { code:'fm', name:'Micronesia', fact:'Light blue with four white stars.' },
        { code:'mh', name:'Marshall Islands', fact:'Blue with orange and white rays.' },
        { code:'bb', name:'Barbados', fact:'A black trident in the center.' },
        { code:'tt', name:'Trinidad and Tobago', fact:'A bold diagonal stripe!' },
        { code:'bs', name:'Bahamas', fact:'Triangle on the left with sea colors.' },
        { code:'bz', name:'Belize', fact:'People and tools show history and work.' },
        { code:'gy', name:'Guyana', fact:'Yellow arrow inside green!' },
        { code:'sr', name:'Suriname', fact:'A big star on a green-red-green flag.' },
        { code:'ht', name:'Haiti', fact:'Blue and red with coat of arms.' },
        { code:'ag', name:'Antigua and Barbuda', fact:'Sun rising over blue, white, black.' },
        { code:'dm', name:'Dominica', fact:'Has a parrot in the middle!' },
        { code:'gd', name:'Grenada', fact:'Red border with stars and nutmeg.' },
        { code:'kn', name:'Saint Kitts and Nevis', fact:'Diagonal with two white stars.' },
        { code:'lc', name:'Saint Lucia', fact:'Blue with yellow and black triangles.' },
        { code:'vc', name:'Saint Vincent', fact:'Green, yellow, blue with diamonds.' },
        { code:'bn', name:'Brunei', fact:'Yellow with black and white stripes.' },
        { code:'tl', name:'Timor-Leste', fact:'Red, black, yellow triangle with star.' },
        { code:'mv', name:'Maldives', fact:'Red with green rectangle and crescent.' },
      ]
    };

    const FLAG_CDN = (code) => `https://flagcdn.com/w640/${code}.png`;

    /*********************
     * State + Storage
     *********************/
    const LS_KEY = 'silasFlagGame_v2';
    const defaultState = {
      difficulty: 'easy',
      mode: 'quiz',
      score: 0,
      streak: 0,
      correctInRow: 0,
      bestStreak: 0,
      strikes: 0,
      soundOn: true,
      gameStarted: false,
      gameOver: false,
      learnedByDiff: { easy:{}, medium:{}, hard:{} },
      seenByDiff: { easy:{}, medium:{}, hard:{} },
      lastCountryCode: null,
      shuffledSeed: Math.floor(Math.random()*1e9),
      milestonesHit: { daily5: false, daily10: false, daily12: false }
    };

    const state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        const merged = structuredClone(defaultState);
        Object.assign(merged, parsed);
        merged.learnedByDiff = Object.assign(structuredClone(defaultState.learnedByDiff), parsed.learnedByDiff||{});
        merged.seenByDiff = Object.assign(structuredClone(defaultState.seenByDiff), parsed.seenByDiff||{});
        merged.milestonesHit = Object.assign(structuredClone(defaultState.milestonesHit), parsed.milestonesHit||{});
        return merged;
      }catch(e){
        return structuredClone(defaultState);
      }
    }

    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    /*********************
     * UI Elements
     *********************/
    const els = {
      score: document.getElementById('score'),
      streak: document.getElementById('streak'),
      bestStreak: document.getElementById('bestStreak'),
      learned: document.getElementById('learned'),
      poolSize: document.getElementById('poolSize'),
      answers: document.getElementById('answers'),
      question: document.getElementById('question'),
      feedback: document.getElementById('feedback'),
      feedbackTitle: document.getElementById('feedbackTitle'),
      feedbackBody: document.getElementById('feedbackBody'),
      flagImg: document.getElementById('flagImg'),
      flagHint: document.getElementById('flagHint'),
      strikes: document.getElementById('strikes'),
      progressBar: document.getElementById('progressBar'),
      btnNext: document.getElementById('btnNext'),
      btnReset: document.getElementById('btnReset'),
      btnSound: document.getElementById('btnSound'),
      btnShuffle: document.getElementById('btnShuffle'),
      btnStart: document.getElementById('btnStart'),
      btnTryAgain: document.getElementById('btnTryAgain'),
      tabQuiz: document.getElementById('tabQuiz'),
      tabLearn: document.getElementById('tabLearn'),
      quizCard: document.getElementById('quizCard'),
      learnCard: document.getElementById('learnCard'),
      learnGrid: document.getElementById('learnGrid'),
      startScreen: document.getElementById('startScreen'),
      gameOverScreen: document.getElementById('gameOverScreen'),
      quizContent: document.getElementById('quizContent'),
      difficultySelect: document.getElementById('difficultySelect'),
      modeBadge: document.getElementById('modeBadge'),
      bonus: document.getElementById('bonus'),
      bonusPill: document.getElementById('bonusPill'),
      challenge: document.getElementById('challenge'),
      challengePill: document.getElementById('challengePill'),
      finalScore: document.getElementById('finalScore'),
      finalStreak: document.getElementById('finalStreak'),
      finalLearned: document.getElementById('finalLearned'),
      finalLevel: document.getElementById('finalLevel'),
      sideCard: document.getElementById('sideCard')
    };

    /*********************
     * Sound (no external files)
     *********************/
    let audioCtx = null;
    function ensureAudio(){
      if(!state.soundOn) return null;
      if(!audioCtx){
        const AC = window.AudioContext || window.webkitAudioContext;
        if(!AC) return null;
        audioCtx = new AC();
      }
      if(audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function beep(pattern){
      const ctx = ensureAudio();
      if(!ctx) return;
      const now = ctx.currentTime;
      let t = now;
      for(const step of pattern){
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = step.type || 'triangle';
        o.frequency.value = step.freq;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ctx.destination);
        o.start(t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(step.gain ?? 0.14, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + (step.dur ?? 0.12));
        o.stop(t + (step.dur ?? 0.12) + 0.02);
        t += (step.dur ?? 0.12) + (step.gap ?? 0.03);
      }
    }

    const sfx = {
      correct(){
        beep([
          {freq: 660, dur:0.08, gain:0.14},
          {freq: 880, dur:0.10, gain:0.16},
          {freq: 990, dur:0.12, gain:0.16}
        ]);
      },
      wrong(){
        beep([
          {freq: 220, dur:0.12, gain:0.16, type:'sawtooth'},
          {freq: 180, dur:0.14, gain:0.14, type:'sawtooth'}
        ]);
      },
      click(){
        beep([{freq: 520, dur:0.05, gain:0.09}]);
      },
      levelUp(){
        beep([
          {freq: 523, dur:0.1, gain:0.16},
          {freq: 659, dur:0.1, gain:0.16},
          {freq: 784, dur:0.1, gain:0.16},
          {freq: 1047, dur:0.2, gain:0.18}
        ]);
      },
      milestone(){
        beep([
          {freq: 880, dur:0.08, gain:0.18},
          {freq: 1100, dur:0.08, gain:0.18},
          {freq: 1320, dur:0.1, gain:0.20},
          {freq: 1760, dur:0.15, gain:0.22}
        ]);
      },
      gameOver(){
        beep([
          {freq: 400, dur:0.15, gain:0.16, type:'sawtooth'},
          {freq: 350, dur:0.15, gain:0.14, type:'sawtooth'},
          {freq: 300, dur:0.2, gain:0.12, type:'sawtooth'},
          {freq: 200, dur:0.3, gain:0.10, type:'sawtooth'}
        ]);
      }
    };

    /*********************
     * Confetti
     *********************/
    const fxCanvas = document.getElementById('fxCanvas');
    const fx = fxCanvas.getContext('2d');
    let particles = [];
    let raf = null;

    function resizeCanvas(){
      const dpr = window.devicePixelRatio || 1;
      fxCanvas.width = Math.floor(window.innerWidth * dpr);
      fxCanvas.height = Math.floor(window.innerHeight * dpr);
      fx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function burstConfetti(count = 80, fromY = 0.22){
      const n = count;
      const cx = window.innerWidth * 0.5;
      const cy = window.innerHeight * fromY;
      const colors = ['#2ee59d','#ffd166','#ff3d9a','#2b3fff','#ffffff','#00ffff','#ff6b35'];
      for(let i=0;i<n;i++){
        particles.push({
          x: cx,
          y: cy,
          vx: (Math.random()*2-1) * (3 + Math.random()*5),
          vy: - (4 + Math.random()*7),
          g: 0.18 + Math.random()*0.18,
          r: 2 + Math.random()*4,
          a: 1,
          rot: Math.random()*Math.PI,
          vr: (Math.random()*2-1) * 0.2,
          color: colors[(Math.random()*colors.length)|0]
        });
      }
      if(!raf) raf = requestAnimationFrame(tickFx);
    }

    function superConfetti(){
      // Big celebration burst from multiple points
      burstConfetti(150, 0.15);
      setTimeout(() => burstConfetti(100, 0.3), 100);
      setTimeout(() => burstConfetti(100, 0.1), 200);
    }

    function tickFx(){
      fx.clearRect(0,0,window.innerWidth, window.innerHeight);
      particles = particles.filter(p => p.a > 0.02 && p.y < window.innerHeight + 40);
      for(const p of particles){
        p.vy += p.g;
        p.x += p.vx;
        p.y += p.vy;
        p.rot += p.vr;
        p.a *= 0.985;
        fx.save();
        fx.globalAlpha = p.a;
        fx.translate(p.x, p.y);
        fx.rotate(p.rot);
        fx.fillStyle = p.color;
        fx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        fx.restore();
      }
      if(particles.length){
        raf = requestAnimationFrame(tickFx);
      }else{
        cancelAnimationFrame(raf);
        raf = null;
      }
    }

    /*********************
     * Helpers
     *********************/
    function mulberry32(a){
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function shuffle(arr, seed){
      const rng = mulberry32(seed);
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rng()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function sample(arr){
      return arr[(Math.random()*arr.length)|0];
    }

    function uniqueByCode(list){
      const m = new Map();
      for(const c of list) m.set(c.code, c);
      return [...m.values()];
    }

    function getPool(){
      const pool = uniqueByCode(COUNTRY_BANK[state.difficulty]);
      return shuffle(pool, state.shuffledSeed + (state.difficulty==='easy'?1:state.difficulty==='medium'?2:3));
    }

    function learnedCount(){
      const learned = state.learnedByDiff[state.difficulty] || {};
      return Object.keys(learned).length;
    }

    function totalLearnedCount(){
      let total = 0;
      for(const diff of ['easy', 'medium', 'hard']){
        total += Object.keys(state.learnedByDiff[diff] || {}).length;
      }
      return total;
    }

    function seenCount(){
      const seen = state.seenByDiff[state.difficulty] || {};
      return Object.keys(seen).length;
    }

    function showStartScreen(){
      els.startScreen.style.display = '';
      els.quizContent.style.display = 'none';
      els.gameOverScreen.classList.remove('show');
      state.gameStarted = false;
      state.gameOver = false;
      saveState();
    }

    function showQuizContent(){
      els.startScreen.style.display = 'none';
      els.quizContent.style.display = '';
      els.gameOverScreen.classList.remove('show');
      state.gameStarted = true;
      state.gameOver = false;
      saveState();
    }

    function showGameOver(){
      state.gameOver = true;
      state.gameStarted = false;
      saveState();
      
      sfx.gameOver();
      
      els.startScreen.style.display = 'none';
      els.quizContent.style.display = 'none';
      els.gameOverScreen.classList.add('show');
      
      els.finalScore.textContent = state.score;
      els.finalStreak.textContent = state.bestStreak;
      els.finalLearned.textContent = totalLearnedCount();
      
      const diffNames = { easy: 'Easy ‚≠ê', medium: 'Medium ‚≠ê‚≠ê', hard: 'Hard ‚≠ê‚≠ê‚≠ê' };
      els.finalLevel.textContent = diffNames[state.difficulty] || 'Easy';
    }

    function startGame(){
      state.score = 0;
      state.streak = 0;
      state.correctInRow = 0;
      state.strikes = 0;
      state.gameOver = false;
      state.gameStarted = true;
      state.milestonesHit = { daily5: false, daily10: false, daily12: false };
      saveState();
      showQuizContent();
      updateStats();
      newQuestion();
    }

    function setMode(mode){
      state.mode = mode;
      saveState();
      const quiz = mode === 'quiz';
      els.quizCard.style.display = quiz ? '' : 'none';
      els.sideCard.style.display = quiz ? '' : 'none';
      els.learnCard.style.display = quiz ? 'none' : '';
      els.tabQuiz.setAttribute('aria-selected', quiz ? 'true' : 'false');
      els.tabLearn.setAttribute('aria-selected', quiz ? 'false' : 'true');
      els.modeBadge.textContent = quiz ? 'Quiz' : 'Learn';
      
      if(!quiz){
        renderLearnMode();
      } else {
        if(!state.gameStarted && !state.gameOver){
          showStartScreen();
        } else if(state.gameOver){
          showGameOver();
        } else {
          showQuizContent();
          newQuestion();
        }
      }
    }

    function setDifficulty(diff){
      state.difficulty = diff;
      state.streak = 0;
      state.correctInRow = 0;
      saveState();
      updateStats();
      renderLearnMode();
      if(state.mode==='quiz' && state.gameStarted && !state.gameOver){
        newQuestion();
      }
    }

    function levelUp(){
      const levels = ['easy', 'medium', 'hard'];
      const currentIdx = levels.indexOf(state.difficulty);
      if(currentIdx < levels.length - 1){
        const newLevel = levels[currentIdx + 1];
        state.difficulty = newLevel;
        state.correctInRow = 0;
        els.difficultySelect.value = newLevel;
        saveState();
        
        // Celebration
        sfx.levelUp();
        superConfetti();
        
        // Flash the difficulty selector
        els.difficultySelect.classList.add('levelUp');
        setTimeout(() => els.difficultySelect.classList.remove('levelUp'), 800);
        
        showFeedback('üöÄ LEVEL UP!', `You advanced to ${newLevel.toUpperCase()} mode! Keep going!`);
        updateStats();
        
        // Short delay before next question
        setTimeout(() => newQuestion(), 1500);
        return true;
      }
      return false;
    }

    function checkAutoLevelUp(){
      // 10 correct in a row
      if(state.correctInRow >= 10){
        return levelUp();
      }
      
      // Completed all flags in current level
      const pool = getPool();
      const learned = state.learnedByDiff[state.difficulty] || {};
      const learnedInLevel = Object.keys(learned).length;
      if(learnedInLevel >= pool.length){
        return levelUp();
      }
      
      return false;
    }

    function checkMilestones(){
      // Daily challenge: 5 streak
      if(state.streak >= 5 && !state.milestonesHit.daily5){
        state.milestonesHit.daily5 = true;
        saveState();
        celebrateMilestone('challengePill', 'üéØ Daily Challenge Complete!');
        return;
      }
      
      // 10 streak
      if(state.streak >= 10 && !state.milestonesHit.daily10){
        state.milestonesHit.daily10 = true;
        saveState();
        celebrateMilestone('bonusPill', 'üî• 10 Streak! Amazing!');
        return;
      }
      
      // 12 streak (super)
      if(state.streak >= 12 && !state.milestonesHit.daily12){
        state.milestonesHit.daily12 = true;
        saveState();
        celebrateMilestone('bonusPill', '‚ö° 12 STREAK! LEGENDARY!');
        superConfetti();
        return;
      }
    }

    function celebrateMilestone(pillId, message){
      sfx.milestone();
      burstConfetti(100, 0.4);
      
      const pill = els[pillId];
      if(pill){
        pill.classList.add('celebrate', 'flash');
        pill.style.background = 'linear-gradient(135deg, rgba(46,229,157,.4), rgba(255,209,102,.4))';
        
        setTimeout(() => {
          pill.classList.remove('celebrate', 'flash');
          pill.style.background = '';
        }, 1500);
      }
      
      showFeedback(message, 'Keep up the incredible work! üåü');
    }

    function setSound(on){
      state.soundOn = on;
      els.btnSound.textContent = `Sound: ${on ? 'ON' : 'OFF'}`;
      saveState();
    }

    function updateStrikes(){
      const hearts = [];
      for(let i = 0; i < 3; i++){
        hearts.push(i < (3 - state.strikes) ? '‚ù§Ô∏è' : 'üñ§');
      }
      els.strikes.textContent = hearts.join('');
    }

    function updateStats(){
      els.score.textContent = state.score;
      els.streak.textContent = state.streak;
      els.bestStreak.textContent = state.bestStreak;
      const pool = getPool();
      els.poolSize.textContent = pool.length;
      els.learned.textContent = learnedCount();
      const pct = pool.length ? Math.round((learnedCount()/pool.length)*100) : 0;
      els.progressBar.style.width = `${pct}%`;

      const bonus = 1 + Math.floor(state.streak/3);
      els.bonus.textContent = `x${bonus}`;

      if(state.bestStreak >= 10) els.challenge.textContent = 'Try a 12 streak!';
      else if(state.bestStreak >= 5) els.challenge.textContent = 'Try a 10 streak!';
      else els.challenge.textContent = 'Get a 5 streak';

      els.difficultySelect.value = state.difficulty;
      updateStrikes();
    }

    function flagAltText(country){
      return `Flag of ${country.name}`;
    }

    /*********************
     * Quiz Engine
     *********************/
    let currentQuestion = null;
    let locked = false;

    function pickNextCountry(pool){
      const learned = state.learnedByDiff[state.difficulty] || {};
      const candidates = pool.filter(c => !learned[c.code] && c.code !== state.lastCountryCode);
      const fallback = pool.filter(c => c.code !== state.lastCountryCode);
      const pickFrom = candidates.length ? candidates : fallback.length ? fallback : pool;

      const seen = state.seenByDiff[state.difficulty] || {};
      const unseen = pickFrom.filter(c => !seen[c.code]);
      return sample(unseen.length ? unseen : pickFrom);
    }

    function buildChoices(correct, pool){
      const others = pool.filter(c => c.code !== correct.code);
      const choices = [correct];
      while(choices.length < 4 && others.length){
        const c = sample(others);
        if(!choices.some(x => x.code === c.code)) choices.push(c);
      }
      while(choices.length < 4) choices.push(correct);
      return shuffle(choices, Math.floor(Math.random()*1e9));
    }

    async function newQuestion(){
      if(state.gameOver) return;
      
      locked = false;
      els.feedback.classList.remove('show');
      els.feedbackTitle.textContent = '';
      els.feedbackBody.textContent = '';
      els.answers.innerHTML = '';

      const pool = getPool();
      if(pool.length < 4){
        els.question.textContent = 'Not enough flags in this difficulty.';
        return;
      }

      const correct = pickNextCountry(pool);
      currentQuestion = { correct, choices: buildChoices(correct, pool) };

      state.seenByDiff[state.difficulty][correct.code] = Date.now();
      state.lastCountryCode = correct.code;
      saveState();

      els.flagHint.textContent = `${state.difficulty.toUpperCase()} ‚Ä¢ Tap an answer`;
      els.flagImg.classList.remove('pop');
      els.flagImg.src = FLAG_CDN(correct.code);
      els.flagImg.alt = flagAltText(correct);
      els.flagImg.onload = () => els.flagImg.classList.add('pop');
      els.flagImg.onerror = () => {
        els.flagHint.textContent = 'Oops ‚Äî flag image did not load. Tap Next.';
      };

      els.question.textContent = 'Which country is this flag?';

      for(const choice of currentQuestion.choices){
        const btn = document.createElement('button');
        btn.className = 'answerBtn';
        btn.type = 'button';
        btn.innerHTML = `<span>${escapeHtml(choice.name)}</span><span class="badge">Choose</span>`;
        btn.addEventListener('click', () => handleAnswer(btn, choice));
        els.answers.appendChild(btn);
      }

      updateStats();
    }

    function handleAnswer(btn, choice){
      if(!currentQuestion || locked) return;
      locked = true;

      const correct = currentQuestion.correct;
      const allButtons = [...els.answers.querySelectorAll('button')];
      allButtons.forEach(b => b.disabled = true);

      const isCorrect = choice.code === correct.code;
      const bonus = 1 + Math.floor(state.streak/3);

      if(isCorrect){
        btn.classList.add('correct');
        btn.querySelector('.badge').textContent = 'Correct!';

        state.streak += 1;
        state.correctInRow += 1;
        state.bestStreak = Math.max(state.bestStreak, state.streak);
        state.score += 10 * bonus;

        const seen = state.seenByDiff[state.difficulty][correct.code];
        if(seen){
          state.learnedByDiff[state.difficulty][correct.code] = Date.now();
        }

        saveState();
        updateStats();
        sfx.correct();
        burstConfetti();

        showFeedback('üéâ You got it!', `${correct.name}. Fun fact: ${correct.fact}`);
        
        // Check milestones
        checkMilestones();
        
        // Check for auto level-up (with delay)
        setTimeout(() => {
          if(!checkAutoLevelUp()){
            // If no level up, continue normally
          }
        }, 500);

      }else{
        btn.classList.add('wrong');
        btn.querySelector('.badge').textContent = 'Not this one';

        for(const b of allButtons){
          const name = b.querySelector('span')?.textContent;
          if(name === correct.name){
            b.classList.add('correct');
            b.querySelector('.badge').textContent = 'This one ‚úÖ';
          }
        }

        state.streak = 0;
        state.correctInRow = 0;
        state.strikes += 1;
        saveState();
        updateStats();
        sfx.wrong();

        if(state.strikes >= 3){
          showFeedback('üí• Three strikes!', `That was ${correct.name}. Game Over!`);
          setTimeout(() => showGameOver(), 1500);
        } else {
          const remaining = 3 - state.strikes;
          showFeedback('So close ‚Äî keep going!', `That was ${correct.name}. ${remaining} ${remaining === 1 ? 'life' : 'lives'} left!`);
        }
      }

      setTimeout(() => { locked = false; }, 250);
    }

    function showFeedback(title, body){
      els.feedbackTitle.textContent = title;
      els.feedbackBody.textContent = body;
      els.feedback.classList.add('show');
    }

    /*********************
     * Learn Mode
     *********************/
    function renderLearnMode(){
      const pool = getPool();
      const learned = state.learnedByDiff[state.difficulty] || {};
      els.learnGrid.innerHTML = '';

      for(const c of pool){
        const item = document.createElement('div');
        item.className = 'learnItem';
        const isLearned = !!learned[c.code];
        item.innerHTML = `
          <img loading="lazy" src="${FLAG_CDN(c.code)}" alt="${escapeHtml(flagAltText(c))}">
          <div class="name">${escapeHtml(c.name)} ${isLearned ? '‚úÖ' : ''}</div>
          <div class="fact">${escapeHtml(c.fact)}</div>
        `;

        item.addEventListener('click', () => {
          item.classList.remove('pop');
          void item.offsetWidth;
          item.classList.add('pop');
          sfx.click();
        });

        els.learnGrid.appendChild(item);
      }
    }

    /*********************
     * Safety helpers
     *********************/
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }

    /*********************
     * Events
     *********************/
    els.btnNext.addEventListener('click', () => { 
      sfx.click(); 
      if(state.gameStarted && !state.gameOver){
        newQuestion(); 
      }
    });

    els.btnStart.addEventListener('click', () => {
      sfx.click();
      startGame();
    });

    els.btnTryAgain.addEventListener('click', () => {
      sfx.click();
      startGame();
    });

    els.btnSound.addEventListener('click', () => {
      setSound(!state.soundOn);
      sfx.click();
    });

    els.btnReset.addEventListener('click', () => {
      const ok = confirm('Reset score, streak, and learned flags?');
      if(!ok) return;
      Object.assign(state, structuredClone(defaultState));
      saveState();
      setSound(true);
      setDifficulty('easy');
      setMode('quiz');
      sfx.click();
      updateStats();
      showStartScreen();
    });

    els.btnShuffle.addEventListener('click', () => {
      state.shuffledSeed = Math.floor(Math.random()*1e9);
      saveState();
      sfx.click();
      if(state.mode==='learn') renderLearnMode();
      if(state.mode==='quiz' && state.gameStarted && !state.gameOver) newQuestion();
    });

    els.tabQuiz.addEventListener('click', () => { sfx.click(); setMode('quiz'); });
    els.tabLearn.addEventListener('click', () => { sfx.click(); setMode('learn'); });

    els.difficultySelect.addEventListener('change', (e) => {
      sfx.click();
      setDifficulty(e.target.value);
    });

    window.addEventListener('pointerdown', () => ensureAudio(), { once:true });

    /*********************
     * Init
     *********************/
    (function init(){
      setSound(state.soundOn);
      els.difficultySelect.value = state.difficulty;
      updateStats();
      
      if(state.mode === 'learn'){
        setMode('learn');
      } else {
        setMode('quiz');
        if(state.gameOver){
          showGameOver();
        } else if(!state.gameStarted){
          showStartScreen();
        } else {
          showQuizContent();
          newQuestion();
        }
      }
    })();
  </script>
</body>
</html>
